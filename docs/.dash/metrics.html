<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assistant Metrics</title>
    <link rel="stylesheet" href="ff.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        margin: 1rem auto;
        max-width: 960px;
        padding: 0 1rem;
      }
      h1 {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
      }
      h2 {
        margin-top: 2rem;
        font-size: 1.25rem;
      }
      .cards {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
      .snapshot {
        margin: 1.5rem 0;
      }
      .snapshot-card {
        border-radius: 12px;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, #eef2ff, #f8fafc);
      }
      .snapshot-card h2 {
        margin: 0 0 0.75rem;
        font-size: 1.35rem;
      }
      .snapshot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem 1.25rem;
      }
      .snapshot-grid .label {
        display: block;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #4b5563;
        margin-bottom: 0.25rem;
      }
      .snapshot-grid .value {
        font-size: 1.3rem;
        font-weight: 600;
        color: #111827;
      }
      .snapshot-grid .trend.up::before {
        content: "▲";
        color: #16a34a;
        margin-right: 0.35rem;
      }
      .snapshot-grid .trend.down::before {
        content: "▼";
        color: #dc2626;
        margin-right: 0.35rem;
      }
      .snapshot-grid .trend.flat::before {
        content: "→";
        color: #6b7280;
        margin-right: 0.35rem;
      }
      canvas {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 1rem;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0.75rem;
        text-align: left;
        font-size: 0.95rem;
      }
      th {
        cursor: pointer;
        background: rgba(0, 0, 0, 0.05);
      }
      th.sort-asc::after {
        content: " ▲";
      }
      th.sort-desc::after {
        content: " ▼";
      }
      #manifest-summary {
        font-size: 0.9rem;
        color: #333;
        margin: 0.5rem 0 1.5rem;
      }
      .empty {
        font-style: italic;
        color: #666;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
<!-- FF-ARTIFACT-HEADER:START -->
<header><a href='index.html'>← Back to FF Assistant Index</a></header>
<!-- FF-ARTIFACT-HEADER:END -->
    <header>
      <h1>Assistant Metrics</h1>
      <p id="manifest-summary">Loading metrics…</p>
    </header>

    <section id="snapshot" class="snapshot" hidden>
      <div class="snapshot-card">
        <h2>Season Snapshot</h2>
        <div class="snapshot-grid">
          <div>
            <span class="label">Latest Week</span>
            <span class="value" id="snapshot-week">—</span>
          </div>
          <div>
            <span class="label">Cumulative Hit%</span>
            <span class="value" id="snapshot-cum-hit">—</span>
          </div>
          <div>
            <span class="label">Cumulative Regret%</span>
            <span class="value" id="snapshot-cum-regret">—</span>
          </div>
          <div>
            <span class="label">Avg Bench Left</span>
            <span class="value" id="snapshot-bench">—</span>
          </div>
          <div>
            <span class="label">Avg Lineup Delta</span>
            <span class="value" id="snapshot-lineup">—</span>
          </div>
          <div>
            <span class="label">Hit-Rate Trend</span>
            <span class="value trend" id="snapshot-trend">—</span>
          </div>
        </div>
      </div>
    </section>

    <section class="cards">
      <canvas id="lineup-delta-chart" height="240"></canvas>
      <canvas id="activity-chart" height="240"></canvas>
      <canvas id="hit-regret-chart" height="240"></canvas>
      <canvas id="bench-chart" height="240"></canvas>
      <canvas id="cum-hit-chart" height="240"></canvas>
      <canvas id="cum-regret-chart" height="240"></canvas>
      <canvas id="rolling-hit-chart" height="200"></canvas>
    </section>

    <section>
      <h2>Weekly Details</h2>
      <div class="table-wrapper">
        <table id="metrics-table">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="table-empty" class="empty" hidden>No metrics rows yet.</p>
    </section>

    <script>
      const CSV_URL = "../.metrics/weekly.csv";
      const MANIFEST_DIR = "../.dash";
      const SNAPSHOT_URL = "../.dash/metrics_snapshot.json";

      const state = {
        rows: [],
        headers: [],
        sortKey: null,
        sortDir: "desc",
        tableBody: null,
        sortMarks: new Map(),
      };

      function parseCSV(text) {
        const lines = text
          .trim()
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter(Boolean);
        if (!lines.length) {
          return { headers: [], rows: [] };
        }
        const headers = lines
          .shift()
          .split(",")
          .map((cell) => cell.trim());
        const rows = lines.map((line) => {
          return line.split(",").reduce((acc, cell, idx) => {
            const key = headers[idx] ?? `col_${idx}`;
            acc[key] = cell.trim();
            return acc;
          }, {});
        });
        return { headers, rows };
      }

      function numberOrNull(value) {
        if (value === undefined || value === null || value === "") {
          return null;
        }
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      }

      function mean(values) {
        if (!values.length) {
          return null;
        }
        const total = values.reduce((sum, value) => sum + value, 0);
        return total / values.length;
      }

      function initTable(headers) {
        const thead = document.querySelector("#metrics-table thead");
        const tr = document.createElement("tr");
        state.sortMarks.clear();
        headers.forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header;
          th.dataset.key = header;
          th.addEventListener("click", () => sortBy(header));
          tr.appendChild(th);
          state.sortMarks.set(header, th);
        });
        thead.innerHTML = "";
        thead.appendChild(tr);
      }

      function renderTable(rows) {
        const tbody = state.tableBody;
        tbody.innerHTML = "";
        if (!rows.length) {
          document.getElementById("table-empty").hidden = false;
          return;
        }
        document.getElementById("table-empty").hidden = true;
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          state.headers.forEach((header) => {
            const td = document.createElement("td");
            td.textContent = row[header] ?? "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      function applySort(rows) {
        const { sortKey, sortDir } = state;
        if (!sortKey) {
          return rows;
        }
        const factor = sortDir === "asc" ? 1 : -1;
        const isNumeric = rows.every((row) => !isNaN(Number(row[sortKey])));
        const sorted = [...rows].sort((a, b) => {
          const aVal = a[sortKey] ?? "";
          const bVal = b[sortKey] ?? "";
          if (isNumeric) {
            const aNum = Number(aVal) || 0;
            const bNum = Number(bVal) || 0;
            return (aNum - bNum) * factor;
          }
          return String(aVal).localeCompare(String(bVal)) * factor;
        });
        return sorted;
      }

      function sortBy(key) {
        if (state.sortKey === key) {
          state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
        } else {
          state.sortKey = key;
          state.sortDir = "asc";
        }
        state.sortMarks.forEach((th, header) => {
          th.classList.remove("sort-asc", "sort-desc");
          if (header === state.sortKey) {
            th.classList.add(state.sortDir === "asc" ? "sort-asc" : "sort-desc");
          }
        });
        renderTable(applySort(state.rows));
      }

      function drawCharts(rows) {
        const weeks = rows.map((row) => row.week);
        const lineupData = rows.map((row) => numberOrNull(row.lineup_delta));
        const waiverData = rows.map((row) => Number(row.waiver_count || 0));
        const tradeTotals = rows.map((row) => {
          const buys = Number(row.trade_buys || 0);
          const sells = Number(row.trade_sells || 0);
          return buys + sells;
        });
        const lateSwapData = rows.map((row) => Number(row.late_swap_suggestions || 0));
        const hitRates = rows.map((row) => numberOrNull(row.hit_rate));
        const regretRates = rows.map((row) => numberOrNull(row.regret_rate));
        const benchLeft = rows.map((row) => numberOrNull(row.points_left_on_bench));
        const cumHit = rows.map((row) => numberOrNull(row.cum_hit_rate));
        const cumRegret = rows.map((row) => numberOrNull(row.cum_regret_rate));
        const l4Hit = rows.map((row) => numberOrNull(row.l4_hit_rate));
        const l4Regret = rows.map((row) => numberOrNull(row.l4_regret_rate));

        const deltaCtx = document.getElementById("lineup-delta-chart")?.getContext("2d");
        const activityCtx = document.getElementById("activity-chart")?.getContext("2d");
        const hitCtx = document.getElementById("hit-regret-chart")?.getContext("2d");
        const benchCtx = document.getElementById("bench-chart")?.getContext("2d");
        const cumHitCtx = document.getElementById("cum-hit-chart")?.getContext("2d");
        const cumRegretCtx = document.getElementById("cum-regret-chart")?.getContext("2d");
        const rollingCtx = document.getElementById("rolling-hit-chart")?.getContext("2d");
        if (deltaCtx) {
          new Chart(deltaCtx, {
            type: "line",
            data: {
              labels: weeks,
              datasets: [
                {
                  label: "Lineup Delta",
                  data: lineupData,
                  spanGaps: true,
                  fill: false,
                  borderColor: "#2f74c0",
                  backgroundColor: "rgba(47, 116, 192, 0.2)",
                  tension: 0.25,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  title: { display: true, text: "Week" },
                },
                y: {
                  title: { display: true, text: "Lineup Delta" },
                },
              },
            },
          });
        }

        if (activityCtx) {
          new Chart(activityCtx, {
            type: "bar",
            data: {
              labels: weeks,
              datasets: [
                {
                  label: "Waiver Count",
                  data: waiverData,
                  backgroundColor: "rgba(67, 160, 71, 0.7)",
                  stack: "activity",
                },
                {
                  label: "Trade Activity",
                  data: tradeTotals,
                  backgroundColor: "rgba(38, 166, 154, 0.7)",
                  stack: "activity",
                },
                {
                  label: "Late Swap Suggestions",
                  data: lateSwapData,
                  backgroundColor: "rgba(239, 108, 0, 0.7)",
                  stack: "activity",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  stacked: true,
                  title: { display: true, text: "Week" },
                },
                y: {
                  stacked: true,
                  title: { display: true, text: "Actions" },
                  beginAtZero: true,
                  ticks: { precision: 0 },
                },
              },
            },
          });
        }

        if (hitCtx) {
          new Chart(hitCtx, {
            type: "line",
            data: {
              labels: weeks,
              datasets: [
                {
                  label: "Waiver Hit Rate (%)",
                  data: hitRates,
                  spanGaps: true,
                  fill: false,
                  borderColor: "#8e44ad",
                  backgroundColor: "rgba(142, 68, 173, 0.2)",
                  tension: 0.25,
                },
                {
                  label: "Regret Rate (%)",
                  data: regretRates,
                  spanGaps: true,
                  fill: false,
                  borderColor: "#e74c3c",
                  backgroundColor: "rgba(231, 76, 60, 0.2)",
                  tension: 0.25,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  title: { display: true, text: "Week" },
                },
                y: {
                  title: { display: true, text: "Rate (%)" },
                  suggestedMin: 0,
                  suggestedMax: 100,
                },
              },
            },
          });
        }

        if (benchCtx) {
          const benchAverage = mean(benchLeft.filter((value) => value !== null));
          new Chart(benchCtx, {
            type: "bar",
            data: {
              labels: weeks,
              datasets: [
                {
                  label: "Points Left on Bench",
                  data: benchLeft,
                  backgroundColor: "rgba(33, 150, 243, 0.7)",
                },
                benchAverage !== null
                  ? {
                      type: "line",
                      label: "Season Avg",
                      data: benchLeft.map(() => benchAverage),
                      borderColor: "#0f172a",
                      borderWidth: 2,
                      fill: false,
                      spanGaps: true,
                    }
                  : null,
              ].filter(Boolean),
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  title: { display: true, text: "Week" },
                },
                y: {
                  title: { display: true, text: "Points" },
                  beginAtZero: true,
                },
              },
            },
          });
        }

        if (cumHitCtx) {
          new Chart(cumHitCtx, {
            type: "line",
            data: {
              labels: weeks,
              datasets: [
                {
                  label: "Cumulative Hit Rate (%)",
                  data: cumHit,
                  spanGaps: true,
                  fill: false,
                  borderColor: "#1d4ed8",
                  backgroundColor: "rgba(29, 78, 216, 0.2)",
                  tension: 0.25,
                },
                {
                  label: "Rolling Last 4 (%)",
                  data: l4Hit,
                  spanGaps: true,
                  fill: false,
                  borderColor: "#2563eb",
                  borderDash: [6, 4],
                  backgroundColor: "rgba(37, 99, 235, 0.12)",
                  tension: 0.25,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { title: { display: true, text: "Week" } },
                y: {
                  title: { display: true, text: "Hit Rate (%)" },
                  suggestedMin: 0,
                  suggestedMax: 100,
                },
              },
            },
          });
        }

        if (cumRegretCtx) {
          new Chart(cumRegretCtx, {
            type: "line",
            data: {
              labels: weeks,
              datasets: [
                {
                  label: "Cumulative Regret Rate (%)",
                  data: cumRegret,
                  spanGaps: true,
                  fill: false,
                  borderColor: "#dc2626",
                  backgroundColor: "rgba(220, 38, 38, 0.18)",
                  tension: 0.25,
                },
                {
                  label: "Rolling Last 4 (%)",
                  data: l4Regret,
                  spanGaps: true,
                  fill: false,
                  borderColor: "#f97316",
                  borderDash: [6, 4],
                  backgroundColor: "rgba(249, 115, 22, 0.12)",
                  tension: 0.25,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { title: { display: true, text: "Week" } },
                y: {
                  title: { display: true, text: "Regret Rate (%)" },
                  suggestedMin: 0,
                  suggestedMax: 100,
                },
              },
            },
          });
        }

        if (rollingCtx) {
          const seasonHitAverage = mean(hitRates.filter((value) => value !== null));
          const validHits = hitRates.filter((value) => value !== null);
          const lastFour = validHits.slice(-4);
          const lastFourAverage = mean(lastFour);
          new Chart(rollingCtx, {
            type: "bar",
            data: {
              labels: ["Season Avg", "Last 4 Weeks"],
              datasets: [
                {
                  label: "Hit Rate (%)",
                  data: [
                    seasonHitAverage ?? 0,
                    lastFourAverage ?? 0,
                  ],
                  backgroundColor: [
                    "rgba(59, 130, 246, 0.7)",
                    "rgba(16, 185, 129, 0.75)",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: "y",
              scales: {
                x: {
                  suggestedMin: 0,
                  suggestedMax: 100,
                  title: { display: true, text: "Hit Rate (%)" },
                },
              },
            },
          });
        }
      }

      async function loadManifest(latestWeek) {
        if (!latestWeek) {
          document.getElementById("manifest-summary").textContent = "Metrics ready.";
          return;
        }
        const manifestPath = `${MANIFEST_DIR}/assistant_manifest_w${latestWeek}.json`;
        try {
          const response = await fetch(manifestPath);
          if (!response.ok) {
            throw new Error(response.statusText);
          }
          const manifest = await response.json();
          const summary = manifest?.summary || manifest?.headline || null;
          const ts = manifest?.generated_at || manifest?.timestamp || "";
          document.getElementById("manifest-summary").textContent = summary
            ? `${summary} (generated ${ts || "recently"})`
            : `Loaded assistant manifest for week ${latestWeek}.`;
        } catch (error) {
          document.getElementById("manifest-summary").textContent = `Metrics ready (no manifest for week ${latestWeek}).`;
        }
      }

      async function loadSnapshot() {
        try {
          const response = await fetch(SNAPSHOT_URL, { cache: "no-cache" });
          if (!response.ok) {
            throw new Error(response.statusText);
          }
          const snapshot = await response.json();
          document.getElementById("snapshot").hidden = false;
          const latestWeek = snapshot?.latest_week ?? "—";
          document.getElementById("snapshot-week").textContent = latestWeek || "—";

          const cumHit = snapshot?.cum_hit_rate;
          document.getElementById("snapshot-cum-hit").textContent =
            cumHit !== null && cumHit !== undefined ? `${cumHit.toFixed(1)}%` : "—";

          const cumRegret = snapshot?.cum_regret_rate;
          document.getElementById("snapshot-cum-regret").textContent =
            cumRegret !== null && cumRegret !== undefined ? `${cumRegret.toFixed(1)}%` : "—";

          const bench = snapshot?.avg_bench_left;
          document.getElementById("snapshot-bench").textContent =
            bench !== null && bench !== undefined ? bench.toFixed(2) : "—";

          const lineup = snapshot?.avg_lineup_delta;
          document.getElementById("snapshot-lineup").textContent =
            lineup !== null && lineup !== undefined ? lineup.toFixed(2) : "—";

          const trendNode = document.getElementById("snapshot-trend");
          const trendValue = snapshot?.trend_hit_rate;
          trendNode.classList.remove("up", "down", "flat");
          if (trendValue === null || trendValue === undefined) {
            trendNode.textContent = "—";
            trendNode.classList.add("flat");
          } else {
            const roundedTrend = trendValue.toFixed(1);
            trendNode.textContent = `${Math.abs(trendValue).toFixed(1)}%`;
            if (trendValue > 0.1) {
              trendNode.classList.add("up");
            } else if (trendValue < -0.1) {
              trendNode.classList.add("down");
            } else {
              trendNode.classList.add("flat");
            }
            trendNode.dataset.value = roundedTrend;
          }
        } catch (error) {
          document.getElementById("snapshot").hidden = true;
        }
      }

      async function init() {
        state.tableBody = document.querySelector("#metrics-table tbody");
        try {
          const response = await fetch(CSV_URL, { cache: "no-cache" });
          if (!response.ok) {
            throw new Error(response.statusText);
          }
          const csvText = await response.text();
          const { headers, rows } = parseCSV(csvText);
          state.headers = headers;
          state.rows = rows;

          if (!headers.length) {
            document.getElementById("manifest-summary").textContent = "No metrics available yet.";
            return;
          }

          initTable(headers);
          renderTable(applySort(rows));

          if (rows.length) {
            drawCharts(rows);
          }

          const latestWeek = rows.reduce((acc, row) => {
            const value = Number(row.week || 0);
            return Number.isFinite(value) ? Math.max(acc, value) : acc;
          }, 0);
          await loadManifest(latestWeek);
          await loadSnapshot();
        } catch (error) {
          document.getElementById("manifest-summary").textContent = `Failed to load metrics: ${error.message}`;
        }
      }

      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
